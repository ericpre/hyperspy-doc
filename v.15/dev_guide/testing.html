

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Running and writing tests &mdash; HyperSpy 1.5 documentation</title>
  

  
  
    <link rel="shortcut icon" href="../_static/hyperspy.ico"/>
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
        <script type="text/javascript" src="../_static/language_data.js"></script>
        <script type="text/javascript" src="../_static/copybutton.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Writing documentation" href="writing_docs.html" />
    <link rel="prev" title="﻿Introduction" href="intro.html" />
 
<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-25260850-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> HyperSpy
          

          
            
            <img src="../_static/hyperspy_logo.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                1.5
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../user_guide/index.html">HyperSpy User Guide</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Developer Guide</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="intro.html">﻿Introduction</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Running and writing tests</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#write-tests">Write tests</a></li>
<li class="toctree-l3"><a class="reference internal" href="#plot-testing">Plot testing</a></li>
<li class="toctree-l3"><a class="reference internal" href="#exporting-pytest-results-as-html">Exporting pytest results as HTML</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="writing_docs.html">Writing documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="coding_style.html">Coding style</a></li>
<li class="toctree-l2"><a class="reference internal" href="lazy_computations.html">Tips for writing methods that work on lazy signals</a></li>
<li class="toctree-l2"><a class="reference internal" href="speeding_up_code.html">Speeding up code</a></li>
<li class="toctree-l2"><a class="reference internal" href="writing_extensions.html">Writing packages that extend HyperSpy</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../api/modules.html">Full HyperSpy API Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../credits.html">Credits</a></li>
<li class="toctree-l1"><a class="reference internal" href="../citing.html">Citing HyperSpy</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">HyperSpy</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="index.html">HyperSpy Developer Guide</a> &raquo;</li>
        
      <li>Running and writing tests</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/dev_guide/testing.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="running-and-writing-tests">
<span id="testing-label"></span><h1>Running and writing tests<a class="headerlink" href="#running-and-writing-tests" title="Permalink to this headline">¶</a></h1>
<div class="section" id="write-tests">
<h2>Write tests<a class="headerlink" href="#write-tests" title="Permalink to this headline">¶</a></h2>
<p>Every new function that is written in to HyperSpy needs to be tested and
documented.</p>
<p>Tests are short functions found in hyperspy/tests that call your functions
under some known conditions and check the outputs against known values. They
should depend on as few other features as possible so that when they break
we know exactly what caused it. Ideally, the tests should be written at the
same time than the code itself, as they are very convenient to run to check
outputs when coding. Writing tests can seem laborious but you’ll probably
soon find that they’re very important as they force you to sanity check all
you do. For details on running and writing HyperSpy test see <span class="xref std std-ref">dev_tests</span></p>
<p>HyperSpy uses the <a class="reference external" href="http://doc.pytest.org/">pytest</a> library for testing. The
tests reside in the <code class="docutils literal notranslate"><span class="pre">hyperspy.tests</span></code> module.</p>
<p>First ensure pytest and its plugins are installed by:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># If using a standard hyperspy install</span>
pip install hyperspy<span class="o">[</span>test<span class="o">]</span>
<span class="c1"># Or, from a hyperspy local development directory</span>
pip install -e .<span class="o">[</span>test<span class="o">]</span>
<span class="c1"># Or just installing the dependencies using conda</span>
conda install -c conda-forge pytest pytest-mpl
</pre></div>
</div>
<p>To run them:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>pytest --mpl --pyargs hyperspy
</pre></div>
</div>
<p>Or, from HyperSpy’s project folder simply:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>pytest
</pre></div>
</div>
<p>Useful hints on testing:</p>
<ul class="simple">
<li><p>When comparing integers, it’s fine to use <code class="docutils literal notranslate"><span class="pre">==</span></code>. When comparing floats, be
sure to use <code class="docutils literal notranslate"><span class="pre">numpy.testing.assert_almost_equal()</span></code> or
<code class="docutils literal notranslate"><span class="pre">numpy.testing.assert_allclose()</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">numpy.testing.assert_equal()</span></code> is convenient to compare numpy arrays.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">hyperspy.misc.test_utils.py</span></code> contains a few useful functions for
testing.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">&#64;pytest.mark.parametrize()</span></code> is a very convenient decorator to test several
parameters of the same function without having to write to much repetitive
code, which is often error-prone. See <a class="reference external" href="http://doc.pytest.org/en/latest/parametrize.html">pytest documentation for more details</a>.</p></li>
<li><p>It is good to check that the tests does not use too much of memory after
creating new tests. If you need to explicitly delete your objects and free
memory, you can do the following to release the memory associated to the
<code class="docutils literal notranslate"><span class="pre">s</span></code> object, for example:</p></li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">del</span> <span class="n">s</span>
<span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
</pre></div>
</div>
<ul class="simple">
<li><p>Once, you have pushed your PR to the official HyperSpy repository, it can be
useful to check the coverage of your tests using the coveralls.io check of
your PR. There should be a link to it at the bottom of your PR on the github
PR page. This service can help you to find how well your code is being tested
and exactly which part is not currently tested.</p></li>
<li><p><a class="reference external" href="https://pypi.python.org/pypi/pytest-sugar">pytest-sugar</a> can be installed
to have a nicer look and feel of pytest in the console (encoding issue have
been reported in the Windows console).</p></li>
</ul>
</div>
<div class="section" id="plot-testing">
<span id="plot-test-label"></span><h2>Plot testing<a class="headerlink" href="#plot-testing" title="Permalink to this headline">¶</a></h2>
<p>Plotting is tested using the <code class="docutils literal notranslate"><span class="pre">&#64;pytest.mark.mpl_image_compare</span></code> decorator of
the <a class="reference external" href="https://pypi.python.org/pypi/pytest-mpl">pytest mpl plugin</a>.  This
decorator uses reference images to compare with the generated output during the
tests. The references images are located in the folder defined by the argument
<code class="docutils literal notranslate"><span class="pre">baseline_dir</span></code> of the <code class="docutils literal notranslate"><span class="pre">&#64;pytest.mark.mpl_image_compare</span></code> decorator.</p>
<p>To run plotting tests, you simply need to add the option <code class="docutils literal notranslate"><span class="pre">--mpl</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pytest</span> <span class="o">--</span><span class="n">mpl</span>
</pre></div>
</div>
<p>If you don’t use the <code class="docutils literal notranslate"><span class="pre">--mpl</span></code>, the code of the tests will be executed but the
images will not be compared to the references images.</p>
<p>If you need to add or change some plots, follow the workflow below:</p>
<blockquote>
<div><ol class="arabic simple">
<li><p>Write the tests using appropriate decorator such as
<code class="docutils literal notranslate"><span class="pre">&#64;pytest.mark.mpl_image_compare</span></code>.</p></li>
<li><p>If you need to generate new reference image in the folder
<code class="docutils literal notranslate"><span class="pre">plot_test_dir</span></code>, for example, run: <code class="docutils literal notranslate"><span class="pre">pytest</span>
<span class="pre">--mpl-generate-path=plot_test_dir</span></code></p></li>
<li><p>Run again the tests and this time they should pass.</p></li>
<li><p>Use <code class="docutils literal notranslate"><span class="pre">git</span> <span class="pre">add</span></code> to put the new file in the git repository.</p></li>
</ol>
</div></blockquote>
<p>When the plotting tests are failling, it is possible to download the figure
comparison images generated by pytest-mpl in the <a class="reference external" href="https://ci.appveyor.com/project/hyperspy/hyperspy/build/1.0.2500/job/2c2qccaktd90po2q/artifacts">artifacts tabs</a>
of the corresponding build.</p>
<dl class="simple">
<dt>The plotting tests need matplotlib &gt; 3.0.0, since small changes in the way</dt><dd><p>matplotlib generates the figure can make the tests fail.</p>
</dd>
</dl>
<p>In travis and appveyor, the matplotlib backend is set to <code class="docutils literal notranslate"><span class="pre">agg</span></code> by setting
the <code class="docutils literal notranslate"><span class="pre">MPLBACKEND</span></code> environment variable to <code class="docutils literal notranslate"><span class="pre">agg</span></code>. At the first import of
<code class="docutils literal notranslate"><span class="pre">matplotlib.pyplot</span></code>, matplotlib will look at the <code class="docutils literal notranslate"><span class="pre">MPLBACKEND</span></code> environment
variable and set accordingly the backend.</p>
<p>See <a class="reference external" href="https://pypi.python.org/pypi/pytest-mpl">pytest-mpl</a> for more details.</p>
</div>
<div class="section" id="exporting-pytest-results-as-html">
<h2>Exporting pytest results as HTML<a class="headerlink" href="#exporting-pytest-results-as-html" title="Permalink to this headline">¶</a></h2>
<p>With <code class="docutils literal notranslate"><span class="pre">pytest-html</span></code> it is possible to export the results of running pytest
for easier viewing. I can be installed by conda:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>conda install pytest-html
</pre></div>
</div>
<p>and run by:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>pytest --mpl --html<span class="o">=</span>report.html
</pre></div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="writing_docs.html" class="btn btn-neutral float-right" title="Writing documentation" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="intro.html" class="btn btn-neutral float-left" title="﻿Introduction" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2011-2019, The HyperSpy development team

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>